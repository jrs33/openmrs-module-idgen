<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.0"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.0
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.0.xsd">

	<changeSet id="1.0" author="Partners In Health">
		<createTable tableName="idgen_identifier_source">
			<column name="id" type="int(11)" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" unique="true"/>
			</column>
			<column name="uuid" type="char(38)">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="description" type="varchar(1000)">
				<constraints nullable="false"/>
			</column>
			<column name="identifier_type" type="int(11)" defaultValue="0">
				<constraints nullable="false" unique="true" foreignKeyName="idgen_identifier_source" references="patient_identifier_type(patient_identifier_type_id)"/>
			</column>
			<column name="creator" type="int(11)" defaultValue="0">
				<constraints nullable="false" unique="true" foreignKeyName="idgen_identifier_source" references="users(user_id)"/>
			</column>
			<column name="date_created" type="datetime">
				<constraints nullable="false"/>
			</column>
			<column name="changed_by" type="int(11)" defaultValue="NULL">
				<constraints nullable="true" unique="true" foreignKeyName="idgen_identifier_source" references="users(user_id)"/>
			</column>
			<column name="date_changed" type="datetime" defaultValue="NULL">
				<constraints nullable="true"/>
			</column>
			<column name="retired" type="tinyint(1)" defaultValue="0">
				<constraints nullable="false"/>
			</column>
			<column name="retired_by" type="int(11)" defaultValue="NULL">
				<constraints nullable="true" unique="true" foreignKeyName="idgen_identifier_source" references="users(user_id)"/>
			</column>
			<column name="date_retired" type="datetime" defaultValue="NULL">
				<constraints nullable="true"/>
			</column>
			<column name="retire_reason" type="varchar(255)" defaultValue="NULL">
				<constraints nullable="true" />
			</column>
		</createTable>
		<createTable tableName="idgen_seq_id_gen">
			<column name="id" type="int(11)">
				<constraints nullable="false" primaryKey="true" foreignKeyName="idgen_seq_id_gen" references="idgen_identifier_source(id)"/>
			</column>
			<column name="next_sequence_value" type="int(11)" defaultValue="-1">
				<constraints nullable="false"/>
			</column>
			<column name="base_character_set" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="first_identifier_base" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
			<column name="prefix" type="varchar(20)">
				<constraints nullable="false"/>
			</column>
			<column name="suffix" type="varchar(20)">
				<constraints nullable="false"/>
			</column>
			<column name="length" type="int(11)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<createTable tableName="idgen_remote_source">
			<column name="id" type="int(11)">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="url" type="varchar(255)">
				<constraints nullable="false" foreignKeyName="idgen_remote_source" references="idgen_identifier_source(id)"/>
			</column>
		</createTable>
		<createTable tableName="idgen_id_pool">
			<column name="id" type="int(11)">
				<constraints nullable="false" primaryKey="true" foreignKeyName="idgen_id_pool" references="idgen_identifier_source(id)"/>
			</column>
			<column name="source" type="int(11)">
				<constraints nullable="true" unique="true" foreignKeyName="idgen_id_pool" references="idgen_identifier_source(id)"/>
			</column>
			<column name="batch_size" type="int(11)">
				<constraints nullable="true"/>
			</column>
			<column name="min_pool_size" type="int(11)">
				<constraints nullable="true"/>
			</column>
			<column name="sequential" type="tinyint(1)" defaultValue="0">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<createTable tableName="idgen_pooled_identifier">
			<column name="id" type="int(11)" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="uuid" type="char(38)">
				<constraints nullable="false"/>
			</column>
			<column name="pool_id" type="int(11)">
				<constraints nullable="false" foreignKeyName="idgen_pooled_identifier" references="idgen_id_pool(id)"/>
			</column>
			<column name="identifier" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
			<column name="date_used" type="datetime">
				<constraints nullable="true"/>
			</column>
			<column name="comment" type="varchar(255)">
				<constraints nullable="true"/>
			</column>
		</createTable>
		<createTable tableName="idgen_auto_generation_option">
			<column name="id" type="int(11)" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="identifier_type" type="int(11)">
				<constraints nullable="false" unique="true" foreignKeyName="idgen_auto_generation_option" references="patient_identifier_type(patient_identifier_type_id)"/>
			</column>
			<column name="source" type="int(11)">
				<constraints nullable="false" foreignKeyName="idgen_auto_generation_option" references="idgen_identifier_source(id)"/>
			</column>
			<column name="manual_entry_enabled" type="tinyint(1)" defaultValue="1">
				<constraints nullable="false"/>
			</column>
			<column name="automatic_generation_enabled" type="tinyint(1)" defaultValue="1">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="1.1" author="Partners In Health">
		<createTable tableName="idgen_log_entry">
			<column name="id" type="int(11)" autoIncrement="true">
				<constraints nullable="false" primaryKey="true" unique="true"/>
			</column>
			<column name="source" type="int(11)">
				<constraints nullable="false" unique="true" foreignKeyName="idgen_log" references="idgen_identifier_source(id)"/>
			</column>
			<column name="identifier" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
			<column name="date_generated" type="datetime">
				<constraints nullable="false"/>
			</column>
			<column name="generated_by" type="int(11)">
				<constraints nullable="false" unique="true" foreignKeyName="idgen_log" references="users(user_id)"/>
			</column>
			<column name="comment" type="varchar(255)" defaultValue="NULL">
				<constraints nullable="true"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="2.0" author="Partners In Health">
		<createTable tableName="idgen_reserved_identifier">
			<column name="id" type="int(11)" autoIncrement="true">
				<constraints nullable="false" primaryKey="true" unique="true"/>
			</column>
			<column name="source" type="int(11)">
				<constraints nullable="false" unique="true" foreignKeyName="idgen_reserved_identifier" references="idgen_identifier_source(id)"/>
			</column>
			<column name="identifier" type="varchar(50)">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="2.4" author="Partners In Health">
		<addColumn tableName="idgen_id_pool">
			<column name="refill_with_scheduled_task" type="tinyint(1)" defaultValue="1">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="2.4.1" author="Partners In Health">
		<addColumn tableName="idgen_remote_source">
			<column name="user" type="varchar(50)">
				<constraints nullable="true"/>
			</column>
		</addColumn>
		<addColumn tableName="idgen_remote_source">
			<column name="password" type="varchar(20)">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="2.4.2" author="Jeremy Keiper">
		<renameColumn tableName="idgen_seq_id_gen" oldColumnName="length" columnDataType="int(11)" newColumnName="min_length">
		</renameColumn>
		<addColumn tableName="idgen_seq_id_gen">
			<column name="max_length" type="int(11)">
				<constraints nullable="true"/>
			</column>
		</addColumn>
		<sql>UPDATE `idgen_seq_id_gen` SET `max_length` = `min_length`</sql>
	</changeSet>

	<changeSet id="2.5" author="Partners In Health">
		<addColumn tableName="idgen_auto_generation_option">
			<column name="location" type="int(11)">
				<constraints nullable="true"/>
			</column>
		</addColumn>
		<addForeignKeyConstraint
				baseTableName="idgen_auto_generation_option"
				constraintName="location_for_auto_generation_option"
				baseColumnNames="location"
				referencedTableName="location"
				referencedColumnNames="location_id"
		/>
	</changeSet>

	<changeSet id="2.5.1" author="Partners In Health">
		<dropForeignKeyConstraint baseTableName="idgen_auto_generation_option" constraintName="identifier_type"/>
		<dropIndex tableName="idgen_auto_generation_option" indexName="identifier_type"/>
		<addForeignKeyConstraint
				constraintName="identifier_type"
				baseTableName="idgen_auto_generation_option"
				baseColumnNames="identifier_type"
				referencedTableName="patient_identifier_type"
				referencedColumnNames="patient_identifier_type_id"/>
 	</changeSet>
</databaseChangeLog>